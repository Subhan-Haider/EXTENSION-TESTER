import re
from pathlib import Path
from typing import Dict, List


class MalwareScanner:
    """Scan for suspicious or obfuscated code patterns."""

    KEYWORDS = [
        "coinhive",
        "cryptonight",
        "miner",
        "keylogger",
        "getallcookies",
        "password",
        "steal",
        "credential",
    ]

    def __init__(self, extension_path: str):
        self.extension_path = Path(extension_path)

    def scan(self) -> Dict:
        warnings = []
        score = 0

        base64_pattern = re.compile(r"[A-Za-z0-9+/]{120,}={0,2}")
        packed_pattern = re.compile(r"eval\s*\(\s*function\(p,a,c,k,e,d\)")
        atob_eval_pattern = re.compile(r"eval\s*\(\s*atob\(")

        for file_path in self.extension_path.rglob("*.js"):
            content = self._safe_read(file_path)
            if not content:
                continue

            if base64_pattern.search(content):
                warnings.append(f"Possible base64 obfuscation in {file_path.relative_to(self.extension_path)}")
                score += 10
            if packed_pattern.search(content):
                warnings.append(f"Packed/obfuscated code detected in {file_path.relative_to(self.extension_path)}")
                score += 15
            if atob_eval_pattern.search(content):
                warnings.append(f"eval(atob()) pattern detected in {file_path.relative_to(self.extension_path)}")
                score += 20

            lower = content.lower()
            for keyword in self.KEYWORDS:
                if keyword in lower:
                    warnings.append(f"Suspicious keyword '{keyword}' in {file_path.relative_to(self.extension_path)}")
                    score += 5

        score = min(100, score)
        return {
            "risk_score": score,
            "warnings": sorted(set(warnings)),
        }

    @staticmethod
    def _safe_read(path: Path) -> str:
        try:
            return path.read_text(encoding="utf-8", errors="ignore")
        except Exception:
            return ""
